<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>11th Annual Prop Bet Challenge Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Prevent bounce scroll on mobile */
        html, body { 
            height: 100%; 
            overflow: hidden; 
            background-color: #f4f6f9; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }

        /* --- 1. FLEXIBLE HEADER --- */
        .header-container { 
            background: linear-gradient(90deg, #C60C30 0%, #002244 40%, #002244 60%, #69BE28 100%);
            color: white; 
            padding: 10px 15px; 
            text-align: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 100;
            position: relative;
            flex-shrink: 0; 
        }
        
        .header-container h2 { font-size: 1.4rem; margin-bottom: 2px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* PULSE ANIMATION */
        .live-indicator {
            display: inline-block;
            width: 10px; height: 10px;
            background-color: #ff3b3b;
            border-radius: 50%;
            box-shadow: 0 0 0 rgba(255, 59, 59, 0.7);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 59, 59, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(255, 59, 59, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 59, 59, 0); }
        }

        /* --- 2. SCROLLABLE WINDOW --- */
        .main-content {
            flex-grow: 1; 
            position: relative;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        .table-container {
            overflow: auto; 
            background: white;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
            height: 100%; 
        }

        table { white-space: nowrap; font-size: 0.9rem; border-collapse: separate; border-spacing: 0; }
        
        /* --- STICKY LOGIC --- */
        thead { position: sticky; top: 0; z-index: 50; }
        .sticky-col { position: sticky; z-index: 20; border-right: 1px solid #dee2e6; }
        thead .sticky-col { z-index: 60 !important; } 

        /* --- COLUMN WIDTHS --- */
        .col-rank { left: 0; min-width: 50px; text-align: center; background-color: #f8f9fa; }
        .col-name { left: 50px; min-width: 180px; text-align: left !important; padding-left: 15px; background-color: #fff; }
        .col-score { left: 230px; min-width: 80px; font-weight: bold; text-align: center; background-color: #fff; }

        /* --- COLORS & STYLES --- */
        .correct-cell { background-color: #d1e7dd !important; color: #0f5132; } 
        .incorrect-cell { background-color: #f8d7da !important; color: #842029; }
        .table-warning { background-color: #fff3cd !important; }
        
        /* Rank 1 Crown Style (Gold Background) */
        .rank-1-cell { 
            background-color: #FFD700 !important; 
            color: #000 !important; 
            border-right: 1px solid #c6a300; 
        }
        
        /* Last Place Ice Style (Light Blue) */
        .rank-last-cell {
            background-color: #e3f2fd !important;
            color: #0d6efd !important;
            border-right: 1px solid #dee2e6;
        }

        /* HEADER STYLING */
        thead tr:first-child th { 
            background-color: #212529; color: white; vertical-align: bottom; text-align: center;
            padding-top: 12px; padding-bottom: 12px; border-bottom: 1px solid #444;
        }
        .key-row td { 
            background-color: #212529 !important; color: #ffc107 !important; font-weight: bold;
            border-bottom: 4px solid #ffd700; text-align: center;
        }
        /* Sticky Fixes */
        thead tr:first-child .sticky-col { background-color: #212529; color: white; }
        thead .key-row .sticky-col { background-color: #212529 !important; color: #ffc107 !important; }

        tbody td { text-align: center; vertical-align: middle; padding: 8px; }
        .loading-msg { padding: 40px; text-align: center; font-style: italic; color: #666; }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            table { font-size: 0.8rem; }
            .header-container h2 { font-size: 1.1rem; }
            .col-rank { min-width: 35px; } 
            .col-name { left: 35px; min-width: 120px; padding-left: 8px; } 
            .col-score { left: 155px; min-width: 50px; } 
            .badge { font-size: 0.6em !important; white-space: normal; }
            #searchInput::placeholder { color: transparent; }
            #searchInput { width: 120px !important; }
        }
    </style>
</head>
<body class="d-flex flex-column">

    <div class="header-container">
        <h2 class="m-0"><span class="live-indicator"></span> 11th Annual Prop Bet Challenge Tracker</h2>
        
        <div class="progress bg-white bg-opacity-25 mt-2 mb-1" style="height: 6px; width: 100%; max-width: 300px; margin: 0 auto; border-radius: 10px;">
            <div id="gameProgress" class="progress-bar bg-warning" role="progressbar" style="width: 0%; border-radius: 10px;"></div>
        </div>

        <p id="lastUpdated" class="m-0 text-white-50" style="font-size: 0.7rem; opacity: 0.8;">Waiting for signal...</p>

        <div class="d-flex justify-content-center gap-2 mt-2">
            <button onclick="loadData()" class="btn btn-warning btn-sm fw-bold shadow-sm" style="font-size: 0.8rem;">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <input type="text" id="searchInput" onkeyup="filterTable()" 
                   class="form-control form-control-sm shadow-sm" 
                   style="max-width: 200px;" placeholder="Find Name...">
        </div>
        
        <div class="text-center mt-2">
            <a href="#" data-bs-toggle="modal" data-bs-target="#rulesModal" class="text-white-50 text-decoration-none" style="font-size: 0.75rem;">
                <i class="fas fa-info-circle"></i> House Rules
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="table-container">
            <table class="table table-hover mb-0" id="prop-table">
                </table>
            <div id="loading" class="loading-msg">Loading data from the field...</div>
        </div>
    </div>

    <div class="modal fade" id="rulesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered p-3">
          <div class="modal-content shadow-lg">
            <div class="modal-header bg-dark text-white">
              <h5 class="modal-title fs-6"><i class="fas fa-gavel text-warning"></i> Official Rules</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-dark" style="white-space: normal; font-size: 0.9rem;">
              <h6 class="fw-bold">1. Grading</h6>
              <p class="small text-muted mb-2">All results are graded based on the live broadcast verdict. Admin decision is final.</p>
              <h6 class="fw-bold">2. Tie Breaker</h6>
              <p class="small text-muted mb-2">Ties are broken by the closest guess to the total game score. You can go over.</p>
              <h6 class="fw-bold">3. Refreshing</h6>
              <p class="small text-muted m-0">Scores update roughly 3-5 minutes after the admin keys them in.</p>
            </div>
            <div class="modal-footer p-1">
              <button type="button" class="btn btn-light btn-sm w-100" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- PASTE YOUR CSV LINK HERE ---
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQnJhX-sCrEbK84FJi1MOIV7v-PDjYDBw5c8Adpqugt9zb4H1PGW42ziWcQhAi1jA/pub?gid=1689955040&single=true&output=csv"; 

        function loadData() {
            const loading = document.getElementById("loading");
            const table = document.getElementById("prop-table");
            
            if(table.innerHTML === "") loading.style.display = "block";

            Papa.parse(sheetUrl, {
                download: true, header: false,
                complete: function(results) { 
                    renderTable(results.data);
                    const now = new Date();
                    document.getElementById("lastUpdated").innerText = "Last Updated: " + now.toLocaleTimeString();
                },
                error: function(err) { loading.innerText = "Error loading data."; }
            });
        }

        function renderTable(data) {
            const table = document.getElementById("prop-table");
            let html = "";
            
            if (!data || data.length < 2) return;

            const headers = data[0]; 
            const keyRow = data[1];  
            const players = data.slice(2); 

            // --- PROGRESS BAR LOGIC ---
            let totalQuestions = headers.length - 2; 
            let answeredQuestions = 0;
            keyRow.forEach((cell, index) => {
                if(index >= 2 && cell && cell !== "") answeredQuestions++;
            });
            let progressPercent = (answeredQuestions / totalQuestions) * 100;
            document.getElementById("gameProgress").style.width = progressPercent + "%";

            // --- STATS LOGIC ---
            let stats = [];
            headers.forEach((h, colIndex) => {
                if(colIndex < 2) { stats.push(null); return; }
                const correctAns = keyRow[colIndex];
                if(!correctAns || correctAns === "") { stats.push(null); return; }

                let correctCount = 0; let totalCount = 0;
                players.forEach(player => {
                    if(player[0]) {
                        totalCount++;
                        if(player[colIndex] === correctAns) correctCount++;
                    }
                });
                let percent = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;
                stats.push(percent + "% Correct"); 
            });

            // --- BUILD HEADERS ---
            html += `<thead><tr>`;
            html += `<th class="sticky-col col-rank">#</th>`; 

            headers.forEach((h, index) => {
                let stickyClass = "";
                if(index === 0) stickyClass = "sticky-col col-name"; 
                if(index === 1) stickyClass = "sticky-col col-score";
                
                let formattedHeader = h ? h.replace(" (", "<br><span class='small fw-normal text-white-50'>(") + "</span>" : "";
                
                if(stats[index]) {
                    let badgeColor = parseInt(stats[index]) > 50 ? 'bg-success' : 'bg-secondary';
                    formattedHeader += `<br><span class="badge ${badgeColor} mt-1">${stats[index]}</span>`;
                }
                html += `<th class="${stickyClass}">${formattedHeader}</th>`;
            });
            html += `</tr>`;

            // --- BUILD KEY ROW ---
            html += `<tr class="key-row">`;
            html += `<td class="sticky-col col-rank">-</td>`; 
            
            keyRow.forEach((cell, index) => {
                let stickyClass = "";
                if(index === 0) stickyClass = "sticky-col col-name";
                if(index === 1) stickyClass = "sticky-col col-score";
                html += `<td class="${stickyClass}">${cell ? cell : "-"}</td>`;
            });
            html += `</tr></thead><tbody>`;

            // --- BUILD PLAYERS ---
            players.forEach((row, rank) => {
                if(!row[0]) return; 

                html += `<tr onclick="toggleHighlight(this)" class="player-row">`;
                
                // 1. RANK LOGIC (Crown for Top, Snow for Bottom)
                let rankContent = rank + 1;
                let rankClass = "sticky-col col-rank fw-bold";
                
                if (rank === 0) { 
                    rankContent = `<i class="fas fa-crown text-dark"></i>`; 
                    rankClass += " rank-1-cell"; 
                } else if (rank === players.length - 1) {
                    rankContent = `<i class="fas fa-snowflake text-primary"></i>`;
                    rankClass += " rank-last-cell";
                }
                html += `<td class="${rankClass}">${rankContent}</td>`;

                // 2. NAME & STREAK LOGIC
                let playerName = row[0]; // Name is index 0
                
               // --- STREAK CALCULATION ---
                let currentStreak = 0;
                
                // FIXED: We start at (row.length - 2) to SKIP the Tie Breaker Column
                // This ensures the math guess doesn't break the streak of correct props
                for (let i = row.length - 2; i >= 2; i--) {
                    const playerAnswer = row[i];
                    const correctAnswer = keyRow[i];
                    
                    // Only count if this question has been graded in the key
                    if (correctAnswer && correctAnswer !== "") {
                        if (playerAnswer === correctAnswer) {
                            currentStreak++;
                        } else {
                            break; // Streak broken
                        }
                    }
                }

                // If streak is 3 or more, add Fire Emoji
                if (currentStreak >= 3) {
                    playerName += ` <span class="badge bg-danger ms-1">ðŸ”¥ ${currentStreak}</span>`;
                }
                
                html += `<td class="sticky-col col-name">${playerName}</td>`;
                html += `<td class="sticky-col col-score">${row[1]}</td>`;

                // 3. ANSWERS LOOP
                row.forEach((cell, index) => {
                    if (index < 2) return; // Skip Name/Score

                    let cssClass = "";
                    let content = cell ? cell : "";

                    const correctAns = keyRow[index];
                    if (correctAns && correctAns.trim() !== "") {
                        if (content === correctAns) {
                            cssClass += " correct-cell"; 
                            content += ` <i class="fas fa-check small text-success"></i>`;
                        } else {
                            cssClass += " incorrect-cell"; 
                        }
                    }
                    html += `<td class="${cssClass}">${content}</td>`;
                });
                html += `</tr>`;
            });

            html += `</tbody>`;
            table.innerHTML = html;
            document.getElementById("loading").style.display = "none";
        }

        function filterTable() {
            const input = document.getElementById("searchInput");
            const filter = input.value.toUpperCase();
            const tr = document.getElementById("prop-table").getElementsByTagName("tr");
            for (let i = 2; i < tr.length; i++) { 
                let td = tr[i].querySelector(".col-name");
                if (td) {
                    let txtValue = td.textContent || td.innerText;
                    tr[i].style.display = (txtValue.toUpperCase().indexOf(filter) > -1) ? "" : "none";
                }
            }
        }

        function toggleHighlight(row) {
            if (row.classList.contains("table-warning")) {
                row.classList.remove("table-warning");
            } else {
                document.querySelectorAll(".player-row").forEach(r => r.classList.remove("table-warning"));
                row.classList.add("table-warning");
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>

