<div class="modal fade" id="chatModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
            <div class="modal-content shadow-lg" style="height: 80vh;">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fs-6"><i class="fas fa-comments"></i> Challenge Chat</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 bg-light">
                    <iframe src="https://www3.cbox.ws/box/?boxid=3551924&boxtag=bMsoTk" 
                            width="100%" 
                            height="100%" 
                            allowtransparency="yes" 
                            allow="autoplay" 
                            frameborder="0" 
                            marginheight="0" 
                            marginwidth="0" 
                            scrolling="auto">
                    </iframe>	
                </div>
            </div>
        </div>
    </div>

    <button type="button" class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center" 
            data-bs-toggle="tooltip" data-bs-placement="left" title="Join the Smack Talk!"
            onclick="var myModal = new bootstrap.Modal(document.getElementById('chatModal')); myModal.show();"
            style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 1000;">
        <i class="fas fa-comment-dots fa-lg"></i>
    </button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- 1. INITIALIZE TOOLTIPS ---
        // This tiny code block makes the hover text work
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // --- 2. PASTE YOUR CSV LINK HERE ---
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQnJhX-sCrEbK84FJi1MOIV7v-PDjYDBw5c8Adpqugt9zb4H1PGW42ziWcQhAi1jA/pub?gid=1689955040&single=true&output=csv"; 

        function loadData() {
            const loading = document.getElementById("loading");
            const table = document.getElementById("prop-table");
            
            if(table.innerHTML === "") loading.style.display = "block";

            Papa.parse(sheetUrl, {
                download: true, header: false,
                complete: function(results) { 
                    renderTable(results.data);
                    const now = new Date();
                    document.getElementById("lastUpdated").innerText = "Last Updated: " + now.toLocaleTimeString();
                },
                error: function(err) { loading.innerText = "Error loading data."; }
            });
        }

        function renderTable(data) {
            const table = document.getElementById("prop-table");
            let html = "";
            
            if (!data || data.length < 2) return;

            const headers = data[0]; 
            const keyRow = data[1];  
            const players = data.slice(2); 

            // --- PROGRESS BAR ---
            let totalQuestions = headers.length - 2; 
            let answeredQuestions = 0;
            keyRow.forEach((cell, index) => {
                if(index >= 2 && cell && cell !== "") answeredQuestions++;
            });
            let progressPercent = (answeredQuestions / totalQuestions) * 100;
            document.getElementById("gameProgress").style.width = progressPercent + "%";

            // --- STATS LOGIC ---
            let stats = [];
            headers.forEach((h, colIndex) => {
                if(colIndex < 2) { stats.push(null); return; }
                const correctAns = keyRow[colIndex];
                if(!correctAns || correctAns === "") { stats.push(null); return; }

                let correctCount = 0; let totalCount = 0;
                players.forEach(player => {
                    if(player[0]) {
                        totalCount++;
                        if(player[colIndex] === correctAns) correctCount++;
                    }
                });
                let percent = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;
                stats.push(percent + "% Correct"); 
            });

            // --- HEADERS ---
            html += `<thead><tr>`;
            html += `<th class="sticky-col col-rank">#</th>`; 

            headers.forEach((h, index) => {
                let stickyClass = "";
                if(index === 0) stickyClass = "sticky-col col-name"; 
                if(index === 1) stickyClass = "sticky-col col-score";
                
                let formattedHeader = h ? h.replace(" (", "<br><span class='small fw-normal text-white-50'>(") + "</span>" : "";
                
                if(stats[index]) {
                    let badgeColor = parseInt(stats[index]) > 50 ? 'bg-success' : 'bg-secondary';
                    formattedHeader += `<br><span class="badge ${badgeColor} mt-1">${stats[index]}</span>`;
                }
                html += `<th class="${stickyClass}">${formattedHeader}</th>`;
            });
            html += `</tr>`;

            // --- KEY ROW ---
            html += `<tr class="key-row">`;
            html += `<td class="sticky-col col-rank">-</td>`; 
            
            keyRow.forEach((cell, index) => {
                let stickyClass = "";
                if(index === 0) stickyClass = "sticky-col col-name";
                if(index === 1) stickyClass = "sticky-col col-score";
                html += `<td class="${stickyClass}">${cell ? cell : "-"}</td>`;
            });
            html += `</tr></thead><tbody>`;

            // --- PLAYERS ---
            players.forEach((row, rank) => {
                if(!row[0]) return; 

                html += `<tr onclick="toggleHighlight(this)" class="player-row">`;
                
                // 1. RANK LOGIC
                let rankContent = rank + 1;
                let rankClass = "sticky-col col-rank fw-bold";
                if (rank === 0) { 
                    rankContent = `<i class="fas fa-crown text-dark"></i>`; 
                    rankClass += " rank-1-cell"; 
                } else if (rank === players.length - 1) {
                    rankContent = `<i class="fas fa-snowflake text-primary"></i>`;
                    rankClass += " rank-last-cell";
                }
                html += `<td class="${rankClass}">${rankContent}</td>`;

                // 2. NAME & STREAK LOGIC
                let playerName = row[0]; 
                
                // STREAK: Ignore last col (Tie Breaker) by using row.length - 2
                let currentStreak = 0;
                for (let i = row.length - 2; i >= 2; i--) {
                    const playerAnswer = row[i];
                    const correctAnswer = keyRow[i];
                    if (correctAnswer && correctAnswer !== "") {
                        if (playerAnswer === correctAnswer) {
                            currentStreak++;
                        } else {
                            break; 
                        }
                    }
                }
                if (currentStreak >= 3) {
                    playerName += ` <span class="badge bg-danger ms-1">ðŸ”¥ ${currentStreak}</span>`;
                }
                
                html += `<td class="sticky-col col-name">${playerName}</td>`;
                html += `<td class="sticky-col col-score">${row[1]}</td>`;

                // 3. ANSWERS
                row.forEach((cell, index) => {
                    if (index < 2) return; 

                    let cssClass = "";
                    let content = cell ? cell : "";

                    const correctAns = keyRow[index];
                    if (correctAns && correctAns.trim() !== "") {
                        if (content === correctAns) {
                            cssClass += " correct-cell"; 
                            content += ` <i class="fas fa-check small text-success"></i>`;
                        } else {
                            cssClass += " incorrect-cell"; 
                        }
                    }
                    html += `<td class="${cssClass}">${content}</td>`;
                });
                html += `</tr>`;
            });

            html += `</tbody>`;
            table.innerHTML = html;
            document.getElementById("loading").style.display = "none";
        }

        function filterTable() {
            const input = document.getElementById("searchInput");
            const filter = input.value.toUpperCase();
            const tr = document.getElementById("prop-table").getElementsByTagName("tr");
            for (let i = 2; i < tr.length; i++) { 
                let td = tr[i].querySelector(".col-name");
                if (td) {
                    let txtValue = td.textContent || td.innerText;
                    tr[i].style.display = (txtValue.toUpperCase().indexOf(filter) > -1) ? "" : "none";
                }
            }
        }

        function toggleHighlight(row) {
            if (row.classList.contains("table-warning")) {
                row.classList.remove("table-warning");
            } else {
                document.querySelectorAll(".player-row").forEach(r => r.classList.remove("table-warning"));
                row.classList.add("table-warning");
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>
